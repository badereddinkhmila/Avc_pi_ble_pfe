{"version":3,"sources":["../service/mqttHelpers.js"],"names":["mqttHelpers","clientId","Url","broker","initBroker","mqtt_options","keepalive","clean","reconnectPeriod","connectTimeout","client","mqtt","connect","console","log","connected","e","db","dbHelpers","fetchFromDB","then","data","length","temp_len","temperature","glu_len","glucose","bp_len","bp","oxy_len","oxygen","weight_len","weight","i","sendTemperature","sendGlucose","sendOxygen","sendBP","sendWeight","DeleteAll","Promise","resolve","reject","msg","collect_time","publish","JSON","stringify","mg_dl","mmol_l","pulse","spo2","diastolic","systolic","bmi","bodyfat"],"mappings":"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","file":"mqttHelpers.js","sourcesContent":["import mqtt from 'mqtt' ;\nimport { dbHelpers } from './dbHelpers'; \n\nexport class mqttHelpers{\n    \n    constructor(clientId,Url){\n        this.clientId=clientId;\n        this.Url=Url;\n        this.broker = this.initBroker();\n    }\n\n    initBroker() {\n        const mqtt_options = {\n            keepalive: 3600,\n            clientId: this.clientId,\n            clean: true,\n            reconnectPeriod: 1000,\n            connectTimeout: 30 * 1000,\n        }     \n        try{    \n            const client = mqtt.connect(this.Url, mqtt_options)\n            console.log('mqtt broker connection state',client.connected);\n            return client;\n        }catch(e){\n            console.log('unable to connect')\n        }\n    }\n\n    checkDB() {\n        const db = new dbHelpers();\n        db.fetchFromDB().then( data =>{\n            if ( data.length == 0) {\n                console.log(\"local database is empty\")\n            }\n\n            const temp_len=data.temperature.length\n            const glu_len=data.glucose.length\n            const bp_len=data.bp.length\n            const oxy_len=data.oxygen\n            const weight_len=data.weight.length\n\n            if(temp_len !==0){ \n                for(let i=0; i< temp_len ;i++){\n                    this.sendTemperature((data.temperature)[i])\n                    console.log((data.temperature)[i])\n                }\n            }\n\n            else if(glu_len !==0){\n                for(let i=0; i< glu_len ;i++){\n                    this.sendGlucose((data.glucose)[i])\n                }\n            }\n\n            else if( oxy_len !==0 ){\n                for(let i=0; i< oxy_len ;i++){\n                    this.sendOxygen((data.oxygen)[i])\n                }\n            }\n            else if(bp_len !==0) {\n                for(let i=0; i< bp_len ;i++){\n                    this.sendBP((data.bp)[i])\n                }\n            }\n\n            else if(weight_len !==0){\n                for(let i=0; i< weight_len ;i++){\n                    this.sendWeight((data.weight)[i])\n                }\n            }\n            db.DeleteAll()\n        })\n    }\n\n\n    sendTemperature(data){\n        return new Promise((resolve,reject)=>{\n            try{  let msg={'gateway_id':this.clientId,'collect_time':data.collect_time,'temperature':data.temperature}\n                    console.log(msg);\n                try{\n                    this.broker.publish('avc/temperature',JSON.stringify(msg))\n                    console.log('successfully sent temperature message');\n                    resolve()\n                }catch(e){\n                    reject(e);\n                }\n            }catch(e){\n                reject(e);\n            }\n        })\n    }\n\n    sendGlucose(data){\n        return new Promise((resolve,reject)=>{\n            try{  let  msg={'gateway_id':this.clientId,'collect_time':data.collect_time,\n                    'mg_dl':data.mg_dl,'mmol_l':data.mmol_l}\n                try{\n                    this.broker.publish('avc/glucose', JSON.stringify(msg))\n                    resolve()\n                }catch(e){\n                    reject(e);\n                }\n            }catch(e){\n                reject(e);\n            }\n        })\n    }\n\n    sendOxygen(data){\n        return new Promise((resolve,reject)=>{\n            try{  let  msg={'gateway_id':this.clientId,'collect_time':data.collect_time,\n                    'pulse':data.pulse,'spo2':data.spo2}\n                try{\n                    this.broker.publish('avc/oxygen',JSON.stringify(msg))\n                    resolve()\n                }catch(e){\n                    reject(e);\n                }\n            }catch(e){\n                reject(e);\n            }\n        })\n    }\n    \n    sendBP(data){\n        return new Promise((resolve,reject)=>{\n            try{    let msg={'gateway_id':this.clientId,'collect_time':data.collect_time,'diastolic':data.diastolic,'pulse':data.pulse,'systolic':data.systolic}\n                try{\n                    this.broker.publish('avc/blood_pressure',JSON.stringify(msg))\n                    console.log(msg)\n                    resolve()\n                }catch(e){\n                    reject(e);\n                }\n            }catch(e){\n                reject(e);\n            }\n        })\n    }\n\n    sendWeight(data){\n        return new Promise((resolve,reject)=>{\n            try{let msg={'gateway_id':this.clientId,'collect_time':data.collect_time,\n                    'bmi':data.bmi,'bodyfat':data.bodyfat,'weight':data.weight}\n                try{\n                    this.broker.publish('avc/weight',JSON.stringify(msg))\n                    resolve()\n                }catch(e){\n                    reject(e);\n                }\n            }catch(e){\n                reject(e);\n            }\n        })\n    }\n}\n"]}